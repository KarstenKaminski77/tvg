(function($){$.fn.suggestionBox=function(options){var $searchBox=this;var settings=$.extend({topOffset:0,leftOffset:0,widthAdjustment:0,delay:400,heading:"Suggestions",results:10,fadeIn:true,fadeOut:false,menuWidth:"auto",showNoSuggestionsMessage:false,noSuggestionsMessage:"No Suggestions Found",filter:false,filterPattern:"({INPUT})",ajaxError:function(e){console.log(e)},ajaxSuccess:function(data){},enterKeyAction:function(){goToSelection()},paramName:"search"},options);$("body").append('<div id="suggestion-box"></div>');$searchBox.attr("autocomplete","off");var $suggestionBox=$("#suggestion-box");setSuggestionBoxPosition();var ENTER_KEY=13;var UP_ARROW_KEY=38;var DOWN_ARROW_KEY=40;var ESCAPE_KEY=27;var selectedLi=-1;var selectedHref="#";var mouseHover=false;var timer=null;var matches=false;var active=false;var request={};var jsonData={};var ajaxCalledVal;$suggestionBox.on({mousemove:function(e){if(e.target.nodeName==="A"){unselect(selectedLi);selectedLi=getSelectionMouseIsOver(e);select(selectedLi);mouseHover=true}},mouseout:function(e){if(e.target.nodeName==="A"){mouseHover=false;unselect(selectedLi);resetSelection()}},click:function(e){if(e.target.nodeName==="A"){$suggestionBox.css("display","none")}}});$searchBox.on({blur:function(){active=false;if(!mouseHover){hideSuggestionBox()}},focus:function(){active=true;if($(this).val()){showSuggestions(jsonData)}},keyup:function(e){if(e.which!==UP_ARROW_KEY&&e.which!==DOWN_ARROW_KEY&&e.which!==ESCAPE_KEY&&e.which!==ENTER_KEY){if(settings.url){resetSelection();if(timer){clearTimeout(timer)}}if(settings.url){request[settings.paramName]=$searchBox.val();timer=setTimeout(function(){getSuggestions(settings.url)},settings.delay)}if(settings.filter){showSuggestions()}}},keydown:function(e){if($suggestionBox.css("display")!=="none"){if(e.which==DOWN_ARROW_KEY){e.preventDefault();moveDown()}if(e.which==UP_ARROW_KEY){e.preventDefault();moveUp()}if(e.which===ENTER_KEY&&selectedLi>-1){e.preventDefault();settings.enterKeyAction()}if(e.which==ESCAPE_KEY){e.preventDefault();hideSuggestionBox()}}},paste:function(){setTimeout(function(){$searchBox.keyup()},200)}});$(window).resize(function(){setSuggestionBoxPosition()});function select(position){selectedHref=$suggestionBox.find("li:eq("+position+") a").attr("href");$suggestionBox.find("li:eq("+position+")").addClass("selected")}function unselect(position){$suggestionBox.find("li:eq("+position+")").removeClass("selected")}function resetSelection(){selectedHref="#";selectedLi=-1;$suggestionBox.find("li").removeClass("selected")}function moveDown(){var listSize=$suggestionBox.find("li").size();if(selectedLi===listSize-1){unselect(selectedLi);resetSelection()}else{unselect(selectedLi);selectedLi++;select(selectedLi)}}function moveUp(){if(selectedLi>0){unselect(selectedLi);selectedLi--;select(selectedLi)}else if(selectedLi==-1){unselect(selectedLi);selectedLi=$suggestionBox.find("li").size()-1;select(selectedLi)}else{unselect(0);resetSelection()}}function goToSelection(){$suggestionBox.css("display","none");window.location=selectedHref}function getSuggestions(url){ajaxCalledVal=$searchBox.val();$.ajax({url:url,data:request,dataType:"json",success:function(data){var selectionHasChanged=true;var currentLi=selectedLi;if(jsonData.results&&data.results){selectionHasChanged=JSON.stringify(jsonData.results[selectedLi])!==JSON.stringify(data.results[selectedLi])}setJsonData(data);showSuggestions();if(currentLi>-1&&$searchBox.val()===ajaxCalledVal&&!selectionHasChanged){selectedLi=currentLi;select(selectedLi)}settings.ajaxSuccess(data)},error:function(e){settings.ajaxError(e)}})}function getSelectionMouseIsOver(e){var $parentLi=$(e.target).parent("li");return $parentLi.parent().children().index($parentLi)}function setSuggestionBoxPosition(){var borders=getCssValue($searchBox,"border-bottom-width")+getCssValue($searchBox,"border-top-width");var padding=getCssValue($searchBox,"padding-bottom")+getCssValue($searchBox,"padding-top");$suggestionBox.css({position:"absolute",left:$searchBox.offset().left+settings.leftOffset,top:$searchBox.offset().top+($searchBox.height()+borders+padding+settings.topOffset)})}function getCssValue(element,name){return parseInt(element.css(name).replace("px",""))}function hideSuggestionBox(){if(settings.fadeOut){$suggestionBox.fadeOut()}else{$suggestionBox.css("display","none")}resetSelection()}function showSuggestionBox(){if(settings.fadeIn){$suggestionBox.fadeIn()}else{$suggestionBox.css("display","block")}}function setSuggestionBoxWidth(){var searchBoxWidth=getSearchBoxWidth()+settings.widthAdjustment;if(settings.menuWidth=="auto"){$suggestionBox.css({"min-width":searchBoxWidth})}else if(settings.menuWidth=="constrain"){$suggestionBox.css({width:searchBoxWidth})}}function getSearchBoxWidth(){return $searchBox.width()+getCssValue($searchBox,"border-left-width")+getCssValue($searchBox,"border-right-width")+getCssValue($searchBox,"padding-left")+getCssValue($searchBox,"padding-right")}function createSuggestionsList(data){var $suggestions='<div id="suggestion-header">'+settings.heading+"</div> "+'<ul id="suggestion-box-list">';$.each(data.results,function(key,value){if(value.suggestion&&value.url){matches=true;var attr="";if(value.attr){$.each(value.attr,function(key,value){var keys=Object.keys(value);for(var i=0;i<keys.length;i++){attr+=keys[i]+'="'+value[keys[i]]+'" '}})}$suggestions+='<li><a href="'+value.url+'" '+attr+">"+value.suggestion+"</a></li>"}else{return false}if(key===settings.results-1){return false}});$suggestions+="</ul>";return $suggestions}function showSuggestions(){resetSelection();matches=false;var data=settings.filter?filterResults($searchBox.val()):jsonData;if(data){if(data.results){var $suggestions=createSuggestionsList(data)}}if(active){if(matches){$suggestionBox.html($suggestions);setSuggestionBoxWidth();showSuggestionBox()}else if(settings.showNoSuggestionsMessage&&$searchBox.val().length>0){setSuggestionBoxWidth();showSuggestionBox();$suggestionBox.html('<div id="no-suggestions">'+settings.noSuggestionsMessage+"</div>")}else{hideSuggestionBox()}}else{hideSuggestionBox()}}function setJsonData(json){if(json){jsonData=json instanceof Object?json:$.parseJSON(json)}else{jsonData={}}}function loadJson(url){$.ajax({url:url,dataType:"json",success:function(data){setJsonData(data)},error:function(e){console.log(e)}})}function filterResults(value){var data;value=value.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");filterPattern=settings.filterPattern.replace("{INPUT}",value);if(!value){return{}}if(jsonData){if(jsonData.results){var regex=new RegExp(filterPattern,"i");data=$.grep(jsonData.results,function(name){return regex.test(name.suggestion)})}}if(settings.sort){data.sort(settings.sort)}var json=JSON.stringify({results:data});return $.parseJSON(json)}return{getSuggestions:function(url){getSuggestions(url);return this},addSuggestions:function(json){setJsonData(json);return this},loadSuggestions:function(url){loadJson(url);return this},getJson:function(){return JSON.stringify(jsonData)},moveUp:function(){moveUp();return this},moveDown:function(){moveDown();return this},selectedUrl:function(){return selectedHref},selectedSuggestion:function(){return $suggestionBox.find("li:eq("+selectedLi+")").text()},position:function(){return selectedLi},select:function(position){unselect(selectedLi);selectedLi=position;select(position);return this},reset:function(){unselect(selectedLi);resetSelection();return this},show:function(){$searchBox.focus();showSuggestions();return this},hide:function(){hideSuggestionBox();return this},url:function(url){settings.url=url;return this},fadeIn:function(fadeIn){settings.fadeIn=fadeIn;return this},fadeOut:function(fadeOut){settings.fadeOut=fadeOut;return this},delay:function(ms){settings.delay=ms;return this},heading:function(heading){settings.heading=heading;return this},results:function(results){settings.results=results;return this},ajaxError:function(ajaxError){settings.ajaxError=ajaxError;return this},ajaxSuccess:function(ajaxSuccess){settings.ajaxSuccess=ajaxSuccess;return this},filter:function(filter){settings.filter=filter;return this},filterPattern:function(pattern){settings.filterPattern=pattern;return this},sort:function(sortFunc){settings.sort=sortFunc;return this},enterKeyAction:function(action){settings.enterKeyAction=action;return this},destroy:function(){$searchBox.unbind(this);$suggestionBox.remove();return null}}}})(jQuery);